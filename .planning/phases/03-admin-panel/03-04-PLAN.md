---
phase: 03-admin-panel
plan: 04
type: execute
wave: 4
depends_on: [1]
files_modified:
  - "app/admin/settings/page.tsx"
  - "app/admin/settings/widget-form.tsx"
  - "app/admin/settings/widget-preview.tsx"
  - "components/ui/color-picker.tsx"
  - "types/widget-settings.ts"
  - "lib/widget-settings.ts"
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Admin changes widget primary color, position (bottom-left/right), and welcome message"
    - "Changes save immediately to database"
    - "Widget reflects new appearance on customer's website without code changes"
  artifacts:
    - path: "app/admin/settings/page.tsx"
      provides: "Widget settings page with form and live preview"
      min_lines: 60
    - path: "app/admin/settings/widget-form.tsx"
      provides: "React Hook Form with Zod validation for widget settings"
      min_lines: 120
    - path: "app/admin/settings/widget-preview.tsx"
      provides: "Live widget preview component showing changes in real-time"
      min_lines: 100
    - path: "types/widget-settings.ts"
      provides: "TypeScript types for widget configuration"
      min_lines: 20
    - path: "lib/widget-settings.ts"
      provides: "Database operations for widget settings CRUD"
      min_lines: 40
  key_links:
    - from: "app/admin/settings/widget-form.tsx"
      to: "app/admin/settings/widget-preview.tsx"
      via: "Form state passed to preview component"
      pattern: "onChange.*setPreviewValues"
    - from: "app/admin/settings/widget-form.tsx"
      to: "lib/widget-settings.ts"
      via: "Save settings to database"
      pattern: "updateWidgetSettings"
    - from: "app/admin/settings/widget-preview.tsx"
      to: "widget.js"
      via: "iframe with posted config"
      pattern: "postMessage.*config"
    - from: "lib/widget-settings.ts"
      to: "widget_settings table"
      via: "UPSERT widget configuration"
      pattern: "from.*widget_settings"

provides_interface:
  - name: WidgetCustomizationService
    type: service
    methods: [getSettings, updateSettings, validateSettings]
    description: Widget appearance and behavior configuration management

assumes_from:
  - phase: 1
    interface: AdminAuthService
    usage: Authentication check before settings access
  - phase: 1
    interface: WidgetLoader
    usage: Widget preview uses actual widget.js for accuracy
---

<objective>
Implement widget customization (ADMIN-03): Admin changes widget primary color, position (bottom-left/right), and welcome message, changes save immediately, and widget reflects new appearance on customer's website without code changes.

Purpose: Enables admins to customize widget appearance to match their brand without touching code. Changes take effect immediately for all users.
Output: Settings page with form for colors, position, welcome message, plus live preview showing changes.
</objective>

<execution_context>
{file:~/.config/opencode/gsd/workflows/execute-plan.md}
{file:~/.config/opencode/gsd/templates/summary.md}
</execution_context>

<context>
@.planning/phases/03-admin-panel/03-01-PLAN.md
@.planning/phases/03-admin-panel/03-RESEARCH.md

# Backend API contracts consumed:
# - GET /api/widget/settings - Get widget settings for tenant
# - POST /api/widget/settings - Update widget settings for tenant
# - widget_settings table stores: tenant_id, primary_color, position, welcome_message, button_text, header_title

# Database Schema Reference:
# CREATE TABLE widget_settings (
#     tenant_id UUID PRIMARY KEY REFERENCES tenants(id) ON DELETE CASCADE,
#     primary_color TEXT DEFAULT '#3B82F6',
#     position TEXT DEFAULT 'bottom-right',
#     welcome_message TEXT DEFAULT 'Hi! How can I help you today?',
#     button_text TEXT DEFAULT 'Chat',
#     header_title TEXT DEFAULT 'Support Chat',
#     updated_at TIMESTAMPTZ DEFAULT NOW()
# );
</context>

<tasks>

<task type="auto">
  <name>Create Widget Settings types</name>
  <files>types/widget-settings.ts</files>
  <action>
    Define TypeScript types for widget customization:

    - Create types/widget-settings.ts file
    - Define WidgetSettings type with:
      - primaryColor: string (hex color, e.g., '#3B82F6')
      - position: 'bottom-right' | 'bottom-left'
      - welcomeMessage: string (1-200 chars)
      - buttonText: string (1-50 chars, default 'Chat')
      - headerTitle: string (1-50 chars, default 'Support Chat')
    - Define WidgetSettingsFormData for form validation
    - Define default settings constant for initialization
    - Export types for use in components
    
    Reference: RESEARCH.md section "Widget Customization Form Pattern".
  </action>
  <verify>
    - Read types/widget-settings.ts
    - Verify WidgetSettings type with all fields
    - Check position union type
    - Verify default settings constant
  </verify>
  <done>
    TypeScript types ready for widget settings components
  </done>
</task>

<task type="auto">
  <name>Create widget settings database operations</name>
  <files>lib/widget-settings.ts</files>
  <action>
    Build database operations for widget settings:

    - Create lib/widget-settings.ts
    - Implement getWidgetSettings(tenantId):
      - Select from widget_settings table
      - Return settings or null if not exists
    - Implement updateWidgetSettings(tenantId, settings):
      - UPSERT into widget_settings table
      - Include all settings fields
      - Set updated_at to NOW()
    - Implement initializeSettings(tenantId):
      - Create default settings if not exists
      - Return created or existing settings
    - Use Supabase client with RLS (automatically filtered by tenant)
    - Handle errors gracefully
    
    Reference: Database schema from RESEARCH.md section "Database Schema".
  </action>
  <verify>
    - Read lib/widget-settings.ts
    - Verify getWidgetSettings implementation
    - Check updateWidgetSettings with UPSERT
    - Verify initializeSettings for new tenants
  </verify>
  <done>
    Database operations ready for widget settings CRUD
  </done>
</task>

<task type="auto">
  <name>Create widget form with Zod validation</name>
  <files>app/admin/settings/widget-form.tsx</files>
  <action>
    Build React Hook Form for widget customization:

    - Create app/admin/settings/widget-form.tsx as Client Component
    - Import useForm from react-hook-form
    - Import zodResolver from @hookform/resolvers/zod
    - Define Zod schema:
      - primaryColor: string regex /^#[0-9A-Fa-f]{6}$/
      - position: enum ['bottom-right', 'bottom-left']
      - welcomeMessage: string min 1 max 200
      - buttonText: string min 1 max 50
      - headerTitle: string min 1 max 50
    - Create form fields:
      - Color picker: Input type="color" + text input with hex validation
      - Position selector: Select with bottom-right/bottom-left options
      - Welcome message: Textarea with max 200 chars
      - Button text: Input with max 50 chars
      - Header title: Input with max 50 chars
    - Add form description/help text for each field
    - Implement onSubmit handler:
      - Call updateWidgetSettings
      - Show loading state during save
      - Show success/error toast
    - Use form defaultValues from props
    
    Reference: RESEARCH.md section "Widget Customization Form Pattern".
  </action>
  <verify>
    - Read app/admin/settings/widget-form.tsx
    - Verify Zod schema with all validations
    - Check all form fields implemented
    - Verify onSubmit handler with toast notifications
  </verify>
  <done>
    Widget customization form ready with validation
  </done>
</task>

<task type="auto">
  <name>Create live widget preview component</name>
  <files>app/admin/settings/widget-preview.tsx</files>
  <action>
    Build live preview component showing widget changes:

    - Create app/admin/settings/widget-preview.tsx
    - Create WidgetPreview component accepting config prop:
      - primaryColor, position, welcomeMessage, buttonText, headerTitle
    - Render preview using actual widget.js via iframe:
      - Create iframe pointing to widget URL
      - Use postMessage to send config to widget
      - Widget renders in iframe with provided config
    - Alternative (simpler): Render mock widget component:
      - Chat bubble button with primary color
      - Position based on position prop
      - Welcome message in chat window
      - Styling matching actual widget
    - Show preview in a card with "Live Preview" label
    - Handle iframe loading states
    - Make preview responsive (mobile view option)
    
    Reference: RESEARCH.md section "Live Preview Pattern" and "Widget Preview Implementation".
  </action>
  <verify>
    - Read app/admin/settings/widget-preview.tsx
    - Verify preview renders with correct config
    - Check color applied to button/accents
    - Verify position affects button placement
    - Check welcome message displayed
  </verify>
  <done>
    Live preview shows widget appearance in real-time
  </done>
</task>

<task type="auto">
  <name>Create settings page layout</name>
  <files>app/admin/settings/page.tsx</files>
  <action>
    Build settings page combining form and preview:

    - Create app/admin/settings/page.tsx as Server Component
    - Fetch current widget settings from database
      - Call getWidgetSettings or initializeSettings
    - Pass settings to Client Component
    - Create two-column layout (desktop):
      - Left: Form for customization
      - Right: Live preview
    - Single column layout (mobile): Form above preview
    - Include page title "Widget Settings"
    - Add description explaining customization options
    - Handle loading state while fetching settings
    
    Reference: RESEARCH.md section "Live Preview Pattern".
  </action>
  <verify>
    - Read app/admin/settings/page.tsx
    - Verify settings fetched from database
    - Check two-column layout on desktop
    - Verify form and preview both rendered
    - Check mobile responsive design
  </verify>
  <done>
    Settings page layout complete with form and preview
  </done>
</task>

<task type="auto">
  <name>Implement form-preview state synchronization</name>
  <files>app/admin/settings/page.tsx</files>
  <action>
    Connect form changes to preview updates:

    - In app/admin/settings/page.tsx:
      - Use useState for previewValues (separate from form)
      - Create handleFormChange callback
      - Pass to WidgetForm as onChange handler
      - When form values change, update previewValues
      - WidgetForm updates previewValues without saving
      - WidgetPreview receives previewValues prop
    - On form submit:
      - Call API to save settings
      - Update previewValues to match saved state
      - Show success toast
    - This provides instant preview without saving
    
    Reference: RESEARCH.md section "Live Preview Pattern".
  </action>
  <verify>
    - Test form field changes
    - Verify preview updates immediately
    - Check that preview reflects current form values
    - Verify saved settings persist to preview
  </verify>
  <done>
    Form changes update preview in real-time
  </done>
</task>

<task type="auto">
  <name>Add color picker component</name>
  <files>components/ui/color-picker.tsx</files>
  <action>
    Create reusable color picker component:

    - Create components/ui/color-picker.tsx
    - Combine color input and text input:
      - Input type="color" for visual selection
      - Input type="text" for hex code entry
      - Sync both inputs
    - Show color preview swatch
    - Add validation for hex format
    - Include label and error message props
    - Style with consistent UI components
    - Use native browser color picker (no external library)
    
    Reference: RESEARCH.md "Don't Hand-Roll" section.
  </action>
  <verify>
    - Read components/ui/color-picker.tsx
    - Verify color visual input works
    - Check text input syncs with color input
    - Verify validation for invalid hex
  </verify>
  <done>
    Color picker component ready for form use
  </done>
</task>

</tasks>

<verification>
- [ ] Color picker allows visual selection and hex entry
- [ ] Position selector shows bottom-right and bottom-left options
- [ ] Welcome message textarea has 200 char limit
- [ ] Form validation shows errors for invalid inputs
- [ ] Live preview updates immediately as form changes
- [ ] Preview shows correct color, position, and message
- [ ] Save button persists settings to database
- [ ] Success toast appears after saving
- [ ] Mobile responsive (single column layout)
- [ ] Default values load for new tenants
</verification>

<success_criteria>
Widget customization complete:
1. Admin changes widget primary color, position (bottom-left/right), and welcome message ✅
2. Changes save immediately to database ✅
3. Widget reflects new appearance on customer's website without code changes ✅
</success_criteria>

<output>
After completion, create `.planning/phases/03-admin-panel/03-04-SUMMARY.md`
</output>
