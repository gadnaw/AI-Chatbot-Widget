---
phase: 03-admin-panel
plan: 03
type: execute
wave: 3
depends_on: [1]
files_modified:
  - "app/admin/conversations/page.tsx"
  - "app/admin/conversations/columns.tsx"
  - "app/admin/conversations/[id]/page.tsx"
  - "types/conversations.ts"
  - "components/conversation-thread.tsx"
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Admin opens admin panel and views conversation list with timestamps"
    - "Admin clicks a conversation to see full thread with user/assistant messages"
    - "Admin can search/filter conversations by date or keyword"
  artifacts:
    - path: "app/admin/conversations/page.tsx"
      provides: "Conversation list page with search and filtering"
      min_lines: 60
    - path: "app/admin/conversations/columns.tsx"
      provides: "DataTable columns for conversations (session, messages, date, actions)"
      min_lines: 60
    - path: "app/admin/conversations/[id]/page.tsx"
      provides: "Conversation thread view with all messages"
      min_lines: 80
    - path: "types/conversations.ts"
      provides: "TypeScript types for conversations and messages"
      min_lines: 30
    - path: "components/conversation-thread.tsx"
      provides: "Thread display component with message bubbles and sources"
      min_lines: 100
  key_links:
    - from: "app/admin/conversations/page.tsx"
      to: "app/admin/conversations/columns.tsx"
      via: "DataTable rendering conversations"
      pattern: "columns.*DataTable"
    - from: "app/admin/conversations/[id]/page.tsx"
      to: "components/conversation-thread.tsx"
      via: "Thread message rendering"
      pattern: "ConversationThread"
    - from: "app/admin/conversations/[id]/page.tsx"
      to: "/api/conversations"
      via: "Fetch conversation with messages"
      pattern: "from.*conversations.*messages"
    - from: "app/admin/conversations/page.tsx"
      to: "/api/conversations"
      via: "Search and filter conversations"
      pattern: "ilike.*OR.*gte.*lte"

provides_interface:
  - name: ConversationHistoryService
    type: service
    methods: [getConversations, getConversation, searchConversations, filterByDate]
    description: Conversation listing and detail operations for admin oversight

assumes_from:
  - phase: 1
    interface: AdminAuthService
    usage: Authentication check before conversation access
  - phase: 2
    interface: RAGPipeline
    usage: Conversation messages with source citations from retrieval
---

<objective>
Implement conversation history view (ADMIN-02): Admin opens admin panel, views conversation list with timestamps, clicks a conversation to see full thread with user/assistant messages, and can search/filter by date or keyword.

Purpose: Enables admins to review customer conversations for quality assurance, identify common questions, and understand chatbot performance.
Output: Conversation list page with search/filter, thread view with message bubbles and citations.
</objective>

<execution_context>
{file:~/.config/opencode/gsd/workflows/execute-plan.md}
{file:~/.config/opencode/gsd/templates/summary.md}
</execution_context>

<context>
@.planning/phases/03-admin-panel/03-01-PLAN.md
@.planning/phases/03-admin-panel/03-02-PLAN.md
@.planning/phases/03-admin-panel/03-RESEARCH.md

# Backend API contracts consumed:
# - GET /api/conversations - List conversations with tenant filtering
# - GET /api/conversations?search=keyword - Search conversations
# - GET /api/conversations?from=date&to=date - Filter by date range
# - GET /api/conversations/{id} - Get conversation with messages
# - conversations table stores: id, tenant_id, session_id, metadata, created_at
# - messages table stores: id, conversation_id, role, content, sources, created_at
</context>

<tasks>

<task type="auto">
  <name>Create Conversation types and interfaces</name>
  <files>types/conversations.ts</files>
  <action>
    Define TypeScript types for conversation management:

    - Create types/conversations.ts file
    - Define Message type with:
      - id: string (UUID)
      - role: 'user' | 'assistant'
      - content: string
      - sources?: { url: string; title: string }[] (from RAG citations)
      - created_at: string (ISO date)
    - Define Conversation type with:
      - id: string (UUID)
      - session_id: string (for display)
      - message_count: number (computed)
      - last_message: string (preview)
      - created_at: string (ISO date)
      - metadata: { user_agent?: string; referrer?: string }
    - Define ConversationDetail type with messages array
    - Define ConversationFilters type for search/filter params
    
    Reference: RESEARCH.md section "Conversation Thread View Pattern".
  </action>
  <verify>
    - Read types/conversations.ts
    - Verify Message type with role and sources
    - Check Conversation type with session_id
    - Verify ConversationDetail with messages array
  </verify>
  <done>
    TypeScript types ready for conversation components
  </done>
</task>

<task type="auto">
  <name>Create DataTable columns for conversations</name>
  <files>app/admin/conversations/columns.tsx</files>
  <action>
    Build TanStack Table columns for conversation list:

    - Create app/admin/conversations/columns.tsx with "use client" directive
    - Define columns:
      1. session_id: Display shortened ID for reference (first 8 chars)
      2. message_count: Number of messages in conversation
      3. last_message: Preview of most recent message (truncate to 50 chars)
      4. created_at: Formatted date using date-fns
      5. actions: View button to navigate to thread
    - Format dates using formatDistanceToNow for relative time (e.g., "2 hours ago")
    - Add hover effect on rows to indicate clickability
    - Style row to look clickable for navigation
    
    Reference: RESEARCH.md section "DataTable Pattern for Documents" (adapted for conversations).
  </action>
  <verify>
    - Read app/admin/conversations/columns.tsx
    - Verify all 5 column definitions
    - Check session_id truncation to 8 chars
    - Verify date formatting with date-fns
  </verify>
  <done>
    Conversation columns ready for DataTable rendering
  </done>
</task>

<task type="auto">
  <name>Create conversation list page with search and filter</name>
  <files>app/admin/conversations/page.tsx</files>
  <action>
    Build conversation management page:

    - Create app/admin/conversations directory
    - Create page.tsx as Server Component:
      - Fetch conversations from API using Supabase client
      - Include filter parameters from URL searchParams
      - Pass conversations data to Client Component DataTable
      - Include search input field
      - Include date range picker for filtering
    - Implement search functionality:
      - Search by session_id or message content
      - Debounce search input to avoid excessive API calls
      - Update URL with search params
    - Implement date filtering:
      - Date range picker for from/to dates
      - Filter conversations by created_at within range
      - Clear filters button
    - Style page with Card layout
    - Add page title "Conversations" with description
    
    Reference: RESEARCH.md section "Conversation Search Implementation".
  </action>
  <verify>
    - Read app/admin/conversations/page.tsx
    - Verify conversations fetched from API with filters
    - Check search input with debouncing
    - Verify date range picker implementation
    - Check DataTable rendered with columns
  </verify>
  <done>
    Admin sees conversation list with search and date filters
  </done>
</task>

<task type="auto">
  <name>Create conversation thread view</name>
  <files>app/admin/conversations/[id]/page.tsx, components/conversation-thread.tsx</files>
  <action>
    Build conversation thread detail page:

    - Create app/admin/conversations/[id]/page.tsx as Server Component:
      - Get conversation ID from params
      - Fetch conversation with messages from API
      - Handle 404 if conversation not found or not accessible
      - Pass conversation data to thread component
    - Create components/conversation-thread.tsx:
      - Display conversation header (session ID, date)
      - Render messages in chronological order
      - User messages: Right-aligned, primary color background
      - Assistant messages: Left-aligned, muted background
      - Show message sources/citations if available (from RAG)
      - Format timestamps using date-fns
      - Handle empty conversation state
    - Add back button to return to conversation list
    - Style thread with clean message bubble design
    
    Reference: RESEARCH.md section "Conversation Thread View Pattern".
  </action>
  <verify>
    - Read app/admin/conversations/[id]/page.tsx
    - Check conversation fetched with messages
    - Verify 404 handling for missing conversation
    - Read components/conversation-thread.tsx
    - Verify message bubble styling for user/assistant
    - Check source citations display
  </verify>
  <done>
    Admin can view full conversation thread with messages
  </done>
</task>

<task type="auto">
  <name>Implement source citations display</name>
  <files>components/conversation-thread.tsx</files>
  <action>
    Add source citations to assistant messages:

    - For each assistant message, check for sources array
    - If sources exist, display them below message:
      - Label: "Sources:" or "References:"
      - List each source as clickable link
      - Show source title (document name, URL)
      - Include page/section info if available
    - Style citations to be visually distinct but not overwhelming
    - Handle case where sources is null/undefined
    - Make links open in new tab (_blank)
    
    Reference: RESEARCH.md section "Conversation Thread View Pattern" (sources display).
  </action>
  <verify>
    - Test assistant message with sources
    - Verify sources displayed as clickable links
    - Check empty sources handling
    - Verify links open in new tab
  </verify>
  <done>
    Admin can see source citations for assistant responses
  </done>
</task>

<task type="auto">
  <name>Add conversation metadata display</name>
  <files>app/admin/conversations/[id]/page.tsx</files>
  <action>
    Display conversation metadata:

    - Show session ID with copy button for easy reference
    - Display conversation creation date with full format
    - Show user agent if available in metadata
    - Show referrer URL if available
    - Display message count summary
    - Add any additional useful metadata
    - Style metadata in a clean info card section
    
    This helps admins understand conversation context.
  </action>
  <verify>
    - Verify session ID display with copy functionality
    - Check full date format (not relative)
    - Verify metadata fields displayed when present
  </verify>
  <done>
    Admin sees conversation metadata for context
  </done>
</task>

</tasks>

<verification>
- [ ] Conversation list shows all conversations with session ID, message count, last message preview, date
- [ ] Search input filters conversations by keyword (session ID or message content)
- [ ] Date range picker filters conversations by date
- [ ] Clicking a conversation navigates to thread view
- [ ] Thread view shows all messages with user/assistant distinction
- [ ] Message bubbles styled correctly (right for user, left for assistant)
- [ ] Source citations displayed for assistant messages with links
- [ ] Back button returns to conversation list
- [ ] Empty conversation state handled gracefully
- [ ] 404 handled for inaccessible conversations
</verification>

<success_criteria>
Conversation history complete:
1. Admin opens admin panel and views conversation list with timestamps ✅
2. Admin clicks a conversation to see full thread with user/assistant messages ✅
3. Admin can search/filter by date or keyword ✅
</success_criteria>

<output>
After completion, create `.planning/phases/03-admin-panel/03-03-SUMMARY.md`
</output>
