---
phase: 03-admin-panel
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - "lib/supabase/client.ts"
  - "lib/supabase/server.ts"
  - "middleware.ts"
  - "app/login/page.tsx"
  - "app/admin/layout.tsx"
  - "app/admin/page.tsx"
  - "components/app-sidebar.tsx"
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Unauthenticated users accessing /admin are redirected to /login"
    - "Authenticated users can access /admin and see sidebar navigation"
    - "Users can sign in with email/password via Supabase Auth"
    - "Users can sign out and are redirected to login"
  artifacts:
    - path: "lib/supabase/client.ts"
      provides: "Browser-side Supabase client with session management"
      min_lines: 40
    - path: "lib/supabase/server.ts"
      provides: "Server-side Supabase client for SSR authentication"
      min_lines: 50
    - path: "middleware.ts"
      provides: "Auth protection middleware for admin routes"
      min_lines: 60
    - path: "app/login/page.tsx"
      provides: "Admin login page with email/password form"
      min_lines: 80
    - path: "app/admin/layout.tsx"
      provides: "Admin layout with sidebar navigation provider"
      min_lines: 40
    - path: "app/admin/page.tsx"
      provides: "Admin dashboard redirect or welcome page"
      min_lines: 20
    - path: "components/app-sidebar.tsx"
      provides: "Sidebar navigation with menu items and logout"
      min_lines: 80
  key_links:
    - from: "middleware.ts"
      to: "/login"
      via: "redirect for unauthenticated users"
      pattern: "redirect.*/login"
    - from: "app/login/page.tsx"
      to: "lib/supabase/client.ts"
      via: "supabase.auth.signInWithPassword"
      pattern: "signInWithPassword"
    - from: "app/admin/layout.tsx"
      to: "components/app-sidebar.tsx"
      via: "SidebarProvider wrapper"
      pattern: "SidebarProvider.*AppSidebar"
    - from: "components/app-sidebar.tsx"
      to: "/login"
      via: "supabase.auth.signOut on logout"
      pattern: "signOut"

provides_interface:
  - name: AdminAuthService
    type: service
    methods: [createClient, getUser, signOut]
    description: Admin authentication with Supabase Auth for session management

assumes_from:
  - phase: 1
    interface: SupabaseConnection
    usage: Database access for authenticated operations
---

<objective>
Implement admin panel foundation: Authentication, layout, and navigation. Unauthenticated users are redirected to login, authenticated users access admin with sidebar navigation.

Purpose: Establishes the authentication infrastructure and layout shell that all subsequent admin features depend on. Without this, no admin features are accessible.
Output: Login page, auth middleware, admin layout with sidebar, Supabase SSR client setup.
</objective>

<execution_context>
{file:~/.config/opencode/gsd/workflows/execute-plan.md}
{file:~/.config/opencode/gsd/templates/summary.md}
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/03-admin-panel/03-RESEARCH.md
@.planning/phases/03-admin-panel/CONTEXT.md

# Tech Stack:
# - Next.js 14 (App Router) + React 18
# - @supabase/supabase-js (client) + @supabase/ssr (SSR)
# - Shadcn/ui + Tailwind CSS

# Cross-Phase Dependencies:
# - Phase 1: Supabase project configured with auth tables
# - All Phase 3 plans depend on authentication being in place

# Key References:
# - CONTEXT.md: "Authentication: Supabase Auth" section with implementation code
# - RESEARCH.md: "Authentication" section for best practices
</context>

<tasks>

<task type="auto">
  <name>Set up Supabase SSR client utilities</name>
  <files>lib/supabase/client.ts, lib/supabase/server.ts</files>
  <action>
    Create Supabase client utilities for server-side rendering authentication:

    - Create lib/supabase/client.ts (browser client):
      - Create browser client using @supabase/supabase-js
      - Export createClient function that works in client components
      - Enable session persistence in localStorage

    - Create lib/supabase/server.ts (SSR client):
      - Create server client using @supabase/ssr
      - Use cookies() from next/headers to manage session
      - Implement getAll() and setAll() for cookie management
      - Export createClient function for server components

    Reference CONTEXT.md implementation code for exact patterns.
  </action>
  <verify>
    - Read lib/supabase/client.ts
    - Verify browser client creation with createBrowserClient
    - Read lib/supabase/server.ts
    - Verify server client creation with createServerClient
    - Check cookie management implementation
  </verify>
  <done>
    Supabase client utilities ready for authentication operations
  </done>
</task>

<task type="auto">
  <name>Create authentication middleware</name>
  <files>middleware.ts</files>
  <action>
    Build middleware for route protection:

    - Create middleware.ts at project root
    - Import { createServerClient } from @supabase/ssr
    - Implement middleware function:
      - Protect /admin/* routes (require authentication)
      - Protect /api/admin/* routes (require authentication)
      - Allow /login, /api/auth/*, and static assets
      - Redirect unauthenticated users to /login
      - Refresh session if needed before redirect
    - Export config with matcher for protected routes
    - Use Next.js middleware for edge runtime

    Reference CONTEXT.md authentication patterns.
  </action>
  <verify>
    - Read middleware.ts
    - Verify /admin/* routes are protected
    - Check redirect to /login for unauthenticated users
    - Verify session refresh logic
    - Check matcher configuration
  </verify>
  <done>
    Admin routes protected, unauthenticated users redirected to login
  </done>
</task>

<task type="auto">
  <name>Create admin login page</name>
  <files>app/login/page.tsx</files>
  <action>
    Build login page with email/password authentication:

    - Create app/login/page.tsx
    - Create LoginPage component as Client Component:
      - Email input field with validation
      - Password input field with show/hide toggle
      - "Sign in" button with loading state
      - Error message display for failed login
      - Success redirect on successful login
    - Implement signInWithPassword using Supabase client:
      - Call supabase.auth.signInWithPassword
      - Handle success: redirect to /admin
      - Handle error: display user-friendly error
      - Handle loading state during authentication
    - Style page with centered card layout
    - Add page title and description
    - Include "Back to website" link

    Reference CONTEXT.md for Supabase auth patterns.
  </action>
  <verify>
    - Read app/login/page.tsx
    - Verify email and password inputs with validation
    - Check signInWithPassword implementation
    - Verify redirect to /admin on success
    - Verify error handling and display
  </verify>
  <done>
    Admin can sign in with email/password
  </done>
</task>

<task type="auto">
  <name>Create admin layout with sidebar provider</name>
  <files>app/admin/layout.tsx</files>
  <action>
    Build admin layout shell with navigation infrastructure:

    - Create app/admin/layout.tsx
    - Implement AdminLayout as Server Component:
      - Fetch current user using server Supabase client
      - Redirect to /login if not authenticated
      - Wrap children with SidebarProvider
      - Include Sidebar and Header components
    - Create admin header with:
      - Admin panel title
      - User email display
      - Sign out button
    - Create two-column layout:
      - Left: Sidebar navigation
      - Right: Main content area
    - Handle loading state while fetching user

    Reference CONTEXT.md admin structure.
  </action>
  <verify>
    - Read app/admin/layout.tsx
    - Verify user authentication check
    - Check SidebarProvider wrapper
    - Verify layout structure (sidebar + content)
    - Verify header with user info and logout
  </verify>
  <done>
    Admin layout ready with sidebar infrastructure
  </done>
</task>

<task type="auto">
  <name>Create sidebar navigation component</name>
  <files>components/app-sidebar.tsx</files>
  <action>
    Build sidebar navigation for admin panel:

    - Create components/app-sidebar.tsx
    - Implement AppSidebar as Client Component:
      - Navigation menu with items:
        - Dashboard (/admin)
        - Sources (/admin/sources)
        - Conversations (/admin/conversations)
        - Widget Settings (/admin/settings)
        - Embed Code (/admin/embed)
      - Each menu item: icon + label + active state
      - Highlight current route using usePathname
      - Smooth transition animations
    - Add "Sign out" button at bottom:
      - Call supabase.auth.signOut
      - Redirect to /login after sign out
      - Show loading state during sign out
    - Style with consistent sidebar design
    - Use Lucide React icons for menu items

    Reference Shadcn/ui sidebar patterns.
  </action>
  <verify>
    - Read components/app-sidebar.tsx
    - Verify all 5 navigation menu items
    - Check active route highlighting
    - Verify signOut implementation
    - Check icon usage with Lucide React
  </verify>
  <done>
    Sidebar navigation with menu items and logout functionality
  </done>
</task>

<task type="auto">
  <name>Create admin dashboard welcome page</name>
  <files>app/admin/page.tsx</files>
  <action>
    Build admin dashboard landing page:

    - Create app/admin/page.tsx
    - Implement AdminDashboard as Server Component:
      - Welcome message with user email
      - Quick stats overview (placeholders for now):
        - Documents count
        - Conversations count
        - Widget status
      - Quick action links:
        - "Manage Sources" → /admin/sources
        - "View Conversations" → /admin/conversations
        - "Customize Widget" → /admin/settings
        - "Get Embed Code" → /admin/embed
    - Style with Card components
    - Add professional admin dashboard appearance
    - This page will be expanded in Plan 03-06

    Reference admin panel design from RESEARCH.md.
  </action>
  <verify>
    - Read app/admin/page.tsx
    - Verify welcome message and user display
    - Check quick action links
    - Verify navigation to all admin sections
    - Check Card component usage
  </done>
  <done>
    Admin dashboard welcome page with quick navigation
  </done>
</task>

</tasks>

<verification>
- [ ] Middleware redirects unauthenticated /admin access to /login
- [ ] Login page displays with email/password form
- [ ] Successful login redirects to /admin
- [ ] Admin layout shows sidebar and header
- [ ] Sidebar navigation has all 5 menu items
- [ ] Logout functionality works and redirects to login
- [ ] All pages have proper loading and error states
- [ ] User session persists across page refreshes
</verification>

<success_criteria>
Foundation complete:
1. Unauthenticated users accessing /admin are redirected to /login ✅
2. Authenticated users can access /admin and see sidebar navigation ✅
3. Users can sign in with email/password via Supabase Auth ✅
4. Users can sign out and are redirected to login ✅
</success_criteria>

<output>
After completion, create `.planning/phases/03-admin-panel/03-01-SUMMARY.md`
</output>
