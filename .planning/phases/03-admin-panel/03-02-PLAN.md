---
phase: 03-admin-panel
plan: 02
type: execute
wave: 2
depends_on: [1]
files_modified:
  - "app/admin/sources/page.tsx"
  - "app/admin/sources/columns.tsx"
  - "app/admin/sources/add-document-dialog.tsx"
  - "app/admin/sources/new/page.tsx"
  - "components/ui/data-table.tsx"
  - "types/documents.ts"
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Admin sees list of all ingested documents with status indicators"
    - "Admin can add new sources (URL, PDF upload, paste text)"
    - "Admin can delete sources and trigger re-indexing"
    - "All changes reflect in chat behavior within 2 minutes"
  artifacts:
    - path: "app/admin/sources/page.tsx"
      provides: "Document management page with DataTable"
      min_lines: 50
    - path: "app/admin/sources/columns.tsx"
      provides: "DataTable columns for documents (title, type, status, chunks, date, actions)"
      min_lines: 80
    - path: "app/admin/sources/add-document-dialog.tsx"
      provides: "Dialog for adding new documents (URL, PDF, text)"
      min_lines: 100
    - path: "types/documents.ts"
      provides: "TypeScript types for Document table"
      min_lines: 20
  key_links:
    - from: "app/admin/sources/page.tsx"
      to: "app/admin/sources/columns.tsx"
      via: "DataTable rendering columns"
      pattern: "columns.*DataTable"
    - from: "app/admin/sources/add-document-dialog.tsx"
      to: "/api/rag/ingest/*"
      via: "POST to document ingestion endpoints"
      pattern: "POST.*api/rag"
    - from: "app/admin/sources/page.tsx"
      to: "/api/rag/documents"
      via: "GET documents list with tenant filtering"
      pattern: "from.*documents.*select"

provides_interface:
  - name: SourcesManagementService
    type: service
    methods: [getDocuments, createDocument, deleteDocument, triggerReindex]
    description: CRUD operations for document management consumed by admin panel

assumes_from:
  - phase: 2
    interface: RAGIngestionPipeline
    usage: Document ingestion via /api/rag/ingest/* endpoints
  - phase: 2
    interface: DocumentService
    usage: Document CRUD operations on documents table with tenant filtering
  - phase: 1
    interface: AdminAuthService
    usage: Authentication check before document operations
---

<objective>
Implement training data source management (ADMIN-01): Admin sees list of all ingested documents with status indicators, can add new sources (URL, PDF upload, paste text), delete sources, and trigger re-indexing—all changes reflect in chat behavior within 2 minutes.

Purpose: Enables admins to manage the knowledge base that powers the chatbot. Documents added/deleted here directly affect what the chatbot can answer.
Output: Document management page with DataTable, add document forms for URL/PDF/text, delete functionality.
</objective>

<execution_context>
{file:~/.config/opencode/gsd/workflows/execute-plan.md}
{file:~/.config/opencode/gsd/templates/summary.md}
</execution_context>

<context>
@.planning/phases/03-admin-panel/03-01-PLAN.md
@.planning/phases/02-rag-pipeline/02-FINAL-SUMMARY.md
@.planning/phases/03-admin-panel/03-RESEARCH.md

# Backend API contracts consumed:
# - GET /api/rag/documents - List all documents for tenant
# - POST /api/rag/ingest/pdf - Upload PDF for ingestion
# - POST /api/rag/ingest/url - Ingest URL for ingestion
# - POST /api/rag/ingest/text - Paste text for ingestion
# - DELETE /api/rag/documents/{id} - Delete document
# - GET /api/rag/ingest/{document_id}/status - Check processing status
</context>

<tasks>

<task type="auto">
  <name>Create Document types and interfaces</name>
  <files>types/documents.ts</files>
  <action>
    Define TypeScript types for document management:

    - Create types/documents.ts file
    - Define Document type with:
      - id: string (UUID)
      - title: string
      - source_type: 'pdf' | 'url' | 'text'
      - source_url?: string (for URL sources)
      - chunk_count: number
      - status: 'processing' | 'ready' | 'failed'
      - created_at: string (ISO date)
      - updated_at: string (ISO date)
    - Define DocumentFormData type for adding documents
    - Export types for use in components
    
    Reference: RESEARCH.md section "DataTable Pattern for Documents".
  </action>
  <verify>
    - Read types/documents.ts
    - Verify Document type with all required fields
    - Check source_type union type
    - Verify status union type
  </verify>
  <done>
    TypeScript types ready for document management components
  </done>
</task>

<task type="auto">
  <name>Create DataTable columns for documents</name>
  <files>app/admin/sources/columns.tsx</files>
  <action>
    Build TanStack Table columns for document display:

    - Create app/admin/sources/columns.tsx with "use client" directive
    - Import ColumnDef from @tanstack/react-table
    - Define columns:
      1. title: Text display with badge for source type
      2. source_type: Badge showing 'PDF', 'URL', or 'TEXT'
      3. chunk_count: Number of chunks created
      4. status: Badge with colors (processing=secondary, ready=default, failed=destructive)
      5. created_at: Formatted date using date-fns
      6. actions: DropdownMenu with View and Delete options
    - Implement row actions:
      - View: Navigate to document detail or show preview
      - Delete: Trigger delete with confirmation
    - Add status indicator colors (green for ready, yellow for processing, red for failed)
    
    Reference: RESEARCH.md section "DataTable Pattern for Documents".
  </action>
  <verify>
    - Read app/admin/sources/columns.tsx
    - Verify all 6 column definitions
    - Check status badge color mapping
    - Verify actions dropdown with Delete option
  </verify>
  <done>
    Document columns ready for DataTable rendering
  </done>
</task>

<task type="auto">
  <name>Create document management page with DataTable</name>
  <files>app/admin/sources/page.tsx, components/ui/data-table.tsx</files>
  <action>
    Build document management page:

    - Create app/admin/sources directory
    - Create page.tsx as Server Component:
      - Fetch documents from API using Supabase client
      - Pass documents data to Client Component DataTable
      - Include "Add Document" button linking to new page or opening dialog
    - Create components/ui/data-table.tsx with reusable DataTable:
      - Accept data and columns props
      - Implement pagination controls
      - Add search/filter functionality
      - Show "No documents" empty state
    - Style page with Card layout
    - Add page title and description
    
    Reference: RESEARCH.md section "DataTable Pattern for Documents".
  </action>
  <verify>
    - Read app/admin/sources/page.tsx
    - Verify documents fetched from API
    - Check DataTable rendered with columns
    - Verify "Add Document" button present
  </verify>
  <done>
    Admin sees document list with status indicators
  </done>
</task>

<task type="auto">
  <name>Create add document dialog</name>
  <files>app/admin/sources/add-document-dialog.tsx</files>
  <action>
    Build dialog for adding new documents:

    - Create add-document-dialog.tsx as Client Component
    - Use Dialog component from @/components/ui/dialog
    - Create tabbed interface for 3 input types:
      1. URL tab: Input field for URL, Validate button
      2. PDF tab: File upload input, progress indicator
      3. Text tab: Textarea for pasting content
    - Implement form validation:
      - URL: Valid URL pattern check
      - PDF: File type and size validation (max 10MB)
      - Text: Min length check (at least 10 characters)
    - On submit:
      - Call appropriate POST /api/rag/ingest/* endpoint
      - Show loading state during upload
      - Show success/error toast
      - Close dialog and refresh document list
    - Handle errors gracefully with user-friendly messages
    
    Reference: RESEARCH.md section "Document Upload Flow".
  </action>
  <verify>
    - Read app/admin/sources/add-document-dialog.tsx
    - Verify 3 input types (URL, PDF, Text)
    - Check form validation for each type
    - Verify API calls to ingestion endpoints
    - Check toast notifications for success/error
  </verify>
  <done>
    Admin can add new documents via URL, PDF upload, or text paste
  </done>
</task>

<task type="auto">
  <name>Implement delete document functionality</name>
  <files>app/admin/sources/page.tsx</files>
  <action>
    Add delete document capability:

    - Add delete action to document row actions dropdown
    - Implement confirmation Dialog before deletion:
      - Show document title
      - Warn that deletion removes all chunks and embeddings
    - Call DELETE /api/rag/documents/{id} endpoint
    - Show loading state during deletion
    - Show success toast on completion
    - Refresh document list after deletion
    - Handle errors (document not found, permission denied)
    - Implement optimistic UI update (remove from list immediately, revert on error)
    
    Reference: RESEARCH.md section "Pitfall 5: Not Using Optimistic Updates".
  </action>
  <verify>
    - Test delete from document actions dropdown
    - Verify confirmation dialog appears
    - Check API DELETE call to /api/rag/documents/{id}
    - Verify document removed from list after deletion
    - Test error handling for invalid document ID
  </verify>
  <done>
    Admin can delete documents with confirmation
  </done>
</task>

<task type="auto">
  <name>Implement re-indexing functionality</name>
  <files>app/admin/sources/page.tsx, app/admin/sources/columns.tsx</files>
  <action>
    Add re-index document capability:

    - Add re-index action to document row actions dropdown (optional alongside delete)
    - Call POST /api/rag/ingest/{document_id}/reindex endpoint
    - Show loading state during re-indexing
    - Update document status from 'ready' to 'processing'
    - Poll status endpoint every 5 seconds until complete
    - Show success toast when re-indexing complete
    - Refresh document list to show updated chunk_count
    
    This allows admins to update documents that have changed.
  </action>
  <verify>
    - Test re-index from document actions dropdown
    - Verify status changes to 'processing' during re-index
    - Check status updates to 'ready' when complete
    - Verify chunk_count reflects new chunks if content changed
  </verify>
  <done>
    Admin can trigger re-indexing for documents
  </done>
</task>

</tasks>

<verification>
- [ ] Document list shows all ingested documents with title, type, chunks, status, date
- [ ] Status badges show correct colors (processing=secondary, ready=default, failed=destructive)
- [ ] "Add Document" button opens dialog with 3 input types
- [ ] URL ingestion validates URL format
- [ ] PDF upload validates file type and size
- [ ] Text input validates minimum length
- [ ] Document deletion works with confirmation
- [ ] Re-indexing functionality available
- [ ] Toast notifications show success/error states
</verification>

<success_criteria>
Source management complete:
1. Admin sees list of all ingested documents with status indicators ✅
2. Admin can add new sources (URL, PDF upload, paste text) ✅
3. Admin can delete sources and trigger re-indexing ✅
4. Changes reflect in chat behavior within 2 minutes (backend handles) ✅
</success_criteria>

<output>
After completion, create `.planning/phases/03-admin-panel/03-02-SUMMARY.md`
</output>
