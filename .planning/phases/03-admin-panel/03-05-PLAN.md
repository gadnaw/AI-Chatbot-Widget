---
phase: 03-admin-panel
plan: 05
type: execute
wave: 5
depends_on: [1, 4]
files_modified:
  - "app/admin/embed/page.tsx"
  - "app/admin/embed/embed-code.tsx"
  - "app/admin/embed/api-key-manager.tsx"
  - "types/api-keys.ts"
  - "lib/api-keys.ts"
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Admin clicks 'Get Embed Code,' system generates exact script tag with correct API key embedded"
    - "Customer copies code, pastes into website, and widget loads with configured appearance and behavior"
  artifacts:
    - path: "app/admin/embed/page.tsx"
      provides: "Embed code generation page with API key management"
      min_lines: 50
    - path: "app/admin/embed/embed-code.tsx"
      provides: "Embed script display with copy functionality"
      min_lines: 80
    - path: "app/admin/embed/api-key-manager.tsx"
      provides: "API key display with show/hide and regenerate functionality"
      min_lines: 80
    - path: "types/api-keys.ts"
      provides: "TypeScript types for API keys"
      min_lines: 15
    - path: "lib/api-keys.ts"
      provides: "API key CRUD operations (create, get, regenerate)"
      min_lines: 40
  key_links:
    - from: "app/admin/embed/embed-code.tsx"
      to: "lib/api-keys.ts"
      via: "Fetch current API key"
      pattern: "getApiKey"
    - from: "app/admin/embed/embed-code.tsx"
      to: "app/admin/settings/widget-preview.tsx"
      via: "Include widget configuration in embed script"
      pattern: "data-primary-color.*data-welcome-message"
    - from: "lib/api-keys.ts"
      to: "api_keys table"
      via: "API key CRUD operations"
      pattern: "from.*api_keys"
    - from: "app/admin/embed/api-key-manager.tsx"
      to: "lib/api-keys.ts"
      via: "Regenerate API key"
      pattern: "regenerateApiKey"

provides_interface:
  - name: EmbedCodeService
    type: service
    methods: [getApiKey, generateEmbedCode, regenerateApiKey]
    description: Embed code generation and API key management for widget deployment

assumes_from:
  - phase: 1
    interface: AdminAuthService
    usage: Authentication check before embed code access
  - phase: 4
    interface: WidgetCustomizationService
    usage: Include widget settings in embed script attributes
---

<objective>
Implement embed code generation (ADMIN-04): Admin clicks "Get Embed Code," system generates the exact script tag with correct API key embedded, customer copies code, pastes into website, and widget loads with the configured appearance and behavior.

Purpose: Provides customers with the exact code snippet needed to embed the chatbot on their website. Includes API key for authentication and widget configuration.
Output: Embed code page with API key display, show/hide toggle, regenerate functionality, and copy-to-clipboard embed script.
</objective>

<execution_context>
{file:~/.config/opencode/gsd/workflows/execute-plan.md}
{file:~/.config/opencode/gsd/templates/summary.md}
</execution_context>

<context>
@.planning/phases/03-admin-panel/03-01-PLAN.md
@.planning/phases/03-admin-panel/03-04-PLAN.md
@.planning/phases/03-admin-panel/03-RESEARCH.md

# Backend API contracts consumed:
# - GET /api/keys/current - Get current API key for tenant
# - POST /api/keys/regenerate - Generate new API key (invalidates old)
# - GET /api/widget/settings - Get widget settings for embed config
# - api_keys table stores: id, tenant_id, key_hash, prefix, created_at, last_used_at

# Database Schema Reference:
# CREATE TABLE api_keys (
#     id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
#     tenant_id UUID REFERENCES tenants(id) ON DELETE CASCADE,
#     key_hash TEXT NOT NULL, -- Store hashed, not plaintext
#     prefix TEXT NOT NULL,   -- "ak_" + first 8 chars for display
#     created_at TIMESTAMPTZ DEFAULT NOW(),
#     last_used_at TIMESTAMPTZ
# );

# Embed Script Template:
# <script
#   src="WIDGET_URL/widget.js"
#   data-api-key="API_KEY"
#   data-primary-color="#3B82F6"
#   data-position="bottom-right"
#   data-welcome-message="Hi! How can I help you today?"
#   async
# ></script>
</context>

<tasks>

<task type="auto">
  <name>Create API Key types and database operations</name>
  <files>types/api-keys.ts, lib/api-keys.ts</files>
  <action>
    Define types and database operations for API key management:

    - Create types/api-keys.ts:
      - Define ApiKey type with: id, tenantId, prefix, createdAt, lastUsedAt
      - Define ApiKeyCreateResult with plaintextKey (only returned on creation)
      - Define RegenerateResult with newKey and plaintextKey

    - Create lib/api-keys.ts:
      - Implement getCurrentKey(tenantId):
        - Select from api_keys table for tenant
        - Return key with prefix (never return full plaintext key)
      - implement createKey(tenantId):
        - Generate new API key (UUID or random string)
        - Hash key with bcrypt for storage
        - Store with prefix for display
        - Return plaintext key only once
      - Implement regenerateKey(tenantId):
        - Create new key (old key remains until next regeneration)
        - Hash and store new key
        - Return new plaintext key
        - Update old key's prefix to indicate revoked
    
    Reference: RESEARCH.md "Embed Code Generation Pattern" and database schema.
  </action>
  <verify>
    - Read types/api-keys.ts
    - Verify ApiKey type with all fields
    - Read lib/api-keys.ts
    - Verify getCurrentKey returns prefix (not plaintext)
    - Check createKey returns plaintext only once
    - Verify regenerateKey creates new key
  </verify>
  <done>
    API key types and database operations ready
  </done>
</task>

<task type="auto">
  <name>Create API key manager component</name>
  <files>app/admin/embed/api-key-manager.tsx</files>
  <action>
    Build API key display and management component:

    - Create app/admin/embed/api-key-manager.tsx as Client Component
    - Display current API key with:
      - Prefix showing first 8 chars (e.g., "ak_abc12345")
      - Show/hide toggle button
      - Copy button for prefix
    - Show key metadata:
      - Created date
      - Last used date
    - Add "Regenerate Key" button with confirmation dialog:
      - Warn that old key will stop working
      - Show new key once after regeneration
      - Explain that widget will stop working until code updated
    - Handle regeneration with loading state
    - Show toast notifications for success/error
    - Use icons: Eye, EyeOff, Copy, RefreshCw
    
    Reference: RESEARCH.md section "Embed Code Generation Pattern".
  </action>
  <verify>
    - Read app/admin/embed/api-key-manager.tsx
    - Verify key prefix displayed with show/hide
    - Check regenerate button with confirmation
    - Verify toast notifications
  </verify>
  <done>
    API key management component ready
  </done>
</task>

<task type="auto">
  <name>Create embed code display component</name>
  <files>app/admin/embed/embed-code.tsx</files>
  <action>
    Build embed script display with copy functionality:

    - Create app/admin/embed/embed-code.tsx as Client Component
    - Accept apiKey and widgetSettings props
    - Generate embed script:
      ```html
      <script
        src="WIDGET_URL/widget.js"
        data-api-key="API_KEY"
        data-primary-color="PRIMARY_COLOR"
        data-position="POSITION"
        data-welcome-message="WELCOME_MESSAGE"
        async
      ></script>
      ```
    - Display in <pre> block with syntax highlighting style
    - Add "Copy Code" button:
      - Uses navigator.clipboard.writeText
      - Shows "Copied!" feedback
      - Toast notification on success
    - Include usage instructions:
      - "Paste this code just before the closing </body> tag"
      - "Widget will load automatically on page visit"
    - Add copy button icon (Copy from lucide-react)
    
    Reference: RESEARCH.md section "Embed Code Generation Pattern".
  </action>
  <verify>
    - Read app/admin/embed/embed-code.tsx
    - Verify embed script includes all data attributes
    - Check copy button functionality
    - Verify usage instructions present
  </verify>
  <done>
    Embed code display ready with copy functionality
  </done>
</task>

<task type="auto">
  <name>Create embed page layout</name>
  <files>app/admin/embed/page.tsx</files>
  <action>
    Build embed page combining API key and embed code:

    - Create app/admin/embed/page.tsx as Server Component
    - Fetch current API key from database:
      - Call getCurrentKey or createKey if not exists
    - Fetch current widget settings:
      - Call getWidgetSettings for config
    - Pass data to Client Components
    - Create page layout:
      - Section 1: API Key Management
      - Section 2: Embed Code Generation
      - Section 3: Installation Instructions
    - Add page title "Embed Code"
    - Add description explaining the process
    - Include links to Settings page for customization
    - Handle loading states
    
    Reference: RESEARCH.md section "Embed Code Generation Pattern".
  </action>
  <verify>
    - Read app/admin/embed/page.tsx
    - Verify API key fetched or created
    - Check widget settings fetched
    - Verify both sections rendered
  </verify>
  <done>
    Embed page layout complete
  </done>
</task>

<task type="auto">
  <name>Implement embed code regeneration flow</name>
  <files>app/admin/embed/api-key-manager.tsx</files>
  <action>
    Handle API key regeneration with proper flow:

    - Add regenerate functionality:
      - User clicks "Regenerate" button
      - Show confirmation dialog with warning
      - User confirms regeneration
      - Call regenerateKey API endpoint
      - Receive new plaintext key
      - Display new key to user with "Save this key!" warning
      - Show explanation that widget needs code update
    - Handle error cases:
      - Regeneration failed - show error toast
      - Network error - retry option
    - Log regeneration event for audit trail
    - Notify admin that old key is now invalid
    
    Reference: RESEARCH.md section "Embed Code Generation Pattern".
  </action>
  <verify>
    - Test regenerate button flow
    - Verify confirmation dialog appears
    - Check new key displayed after regeneration
    - Test error handling
  </verify>
  <done>
    API key regeneration works correctly
  </done>
</task>

<task type="auto">
  <name>Add installation instructions and testing guidance</name>
  <files>app/admin/embed/page.tsx</files>
  <action>
    Create comprehensive installation guidance:

    - Add "Installation Instructions" section:
      1. Copy the embed code
      2. Paste into HTML before </body> tag
      3. Widget loads automatically
      4. Customization applies automatically from settings
    - Add "Testing Your Widget" section:
      1. Open your website in browser
      2. Look for chat bubble in configured position
      3. Click to open widget
      4. Send test message to verify functionality
    - Add troubleshooting tips:
      - Widget not appearing? Check console for errors
      - Wrong appearance? Refresh page to load new settings
      - API key issues? Verify key matches exactly
    - Add link to support resources
    
    This helps customers successfully install the widget.
  </action>
  <verify>
    - Read app/admin/embed/page.tsx
    - Verify installation instructions present
    - Check testing guidance section
    - Verify troubleshooting tips
  </verify>
  <done>
    Installation instructions help customers deploy widget
  </done>
</task>

</tasks>

<verification>
- [ ] API key displayed with show/hide toggle
- [ ] Copy button copies API key prefix
- [ ] Regenerate button with confirmation dialog
- [ ] New key displayed after regeneration with warning
- [ ] Embed script includes all data attributes
- [ ] Copy to clipboard works for embed script
- [ ] Installation instructions clear and comprehensive
- [ ] Testing guidance helps verify deployment
- [ ] Toast notifications for all actions
- [ ] Loading states during API calls
</verification>

<success_criteria>
Embed code generation complete:
1. Admin clicks "Get Embed Code," system generates exact script tag with correct API key embedded ✅
2. Customer copies code, pastes into website, and widget loads with configured appearance and behavior ✅
</success_criteria>

<output>
After completion, create `.planning/phases/03-admin-panel/03-05-SUMMARY.md`
</output>
